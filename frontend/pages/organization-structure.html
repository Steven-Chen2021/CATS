<section class="page-content organization-structure" aria-labelledby="organizationStructureTitle">
  <header class="page-header">
    <h1 id="organizationStructureTitle">組織架構設定</h1>
    <p>以視覺化表格管理企業的國家、區域與站點配置。</p>
  </header>

  <article class="table-card" aria-label="組織架構表格">
    <div id="organizationStructureTable" class="hot-container" role="application"></div>
  </article>
</section>

<script>
  (function () {
    const HANDSONTABLE_STYLE_URL =
      'https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css';
    const HANDSONTABLE_SCRIPT_URL =
      'https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js';

    const demoData = [
      { country: '台灣', region: '北部區域', site: '台北總部' },
      { country: '台灣', region: '南部區域', site: '高雄營運中心' },
      { country: '日本', region: '關東區域', site: '東京辦公室' }
    ];

    const columnDefinitions = [
      { header: '國家', data: 'country', type: 'text' },
      { header: '區', data: 'region', type: 'text' },
      { header: '站點', data: 'site', type: 'text' }
    ];

    function disconnectObserver(container) {
      const existingObserver = container.__handsontableResizeObserver;
      if (existingObserver) {
        existingObserver.disconnect();
        container.__handsontableResizeObserver = null;
      }
    }

    function attachResizeObserver(container) {
      if (!window.ResizeObserver) {
        const resizeHandler = () => {
          const instance = container.__handsontableInstance;
          if (!instance) {
            return;
          }

          const width = container.clientWidth || container.parentElement?.clientWidth || 0;
          if (width > 0) {
            instance.updateSettings({ width });
            instance.render();
          }
        };

        window.addEventListener('resize', resizeHandler, { passive: true });
        container.__handsontableResizeObserver = {
          disconnect() {
            window.removeEventListener('resize', resizeHandler);
          }
        };
        return;
      }

      const resizeObserver = new ResizeObserver(() => {
        const instance = container.__handsontableInstance;
        if (!instance) {
          return;
        }

        const width = container.clientWidth || container.parentElement?.clientWidth || 0;

        if (width > 0) {
          instance.updateSettings({ width });
          instance.render();
        }
      });

      resizeObserver.observe(container);
      container.__handsontableResizeObserver = resizeObserver;
    }

    function ensureStylesheet() {
      if (document.querySelector('link[data-handsontable-stylesheet]')) {
        return;
      }

      const stylesheet = document.createElement('link');
      stylesheet.rel = 'stylesheet';
      stylesheet.href = HANDSONTABLE_STYLE_URL;
      stylesheet.dataset.handsontableStylesheet = 'true';
      document.head.appendChild(stylesheet);
    }

    function initializeTable() {
      const container = document.getElementById('organizationStructureTable');
      if (!container || !window.Handsontable) {
        return;
      }

      if (container.__handsontableInstance) {
        container.__handsontableInstance.destroy();
      }

      disconnectObserver(container);

      const initialWidth = container.clientWidth || container.parentElement?.clientWidth || 0;

      const hot = new window.Handsontable(container, {
        data: demoData,
        columns: columnDefinitions.map(({ header, ...column }) => column),
        colHeaders: columnDefinitions.map(({ header }) => header),
        licenseKey: 'non-commercial-and-evaluation',
        stretchH: 'all',
        height: 'auto',
        width: initialWidth > 0 ? initialWidth : undefined,
        manualColumnResize: true,
        manualRowResize: true,
        rowHeaders: true,
        readOnly: true,
        className: 'htMiddle',
        headerClassName: 'htCenter',
        autoColumnSize: { useHeaders: true }
      });

      container.__handsontableInstance = hot;

      attachResizeObserver(container);
    }

    function loadHandsontable() {
      if (window.Handsontable) {
        initializeTable();
        return;
      }

      ensureStylesheet();

      let script = document.querySelector('script[data-handsontable-script]');

      if (!script) {
        script = document.createElement('script');
        script.src = HANDSONTABLE_SCRIPT_URL;
        script.dataset.handsontableScript = 'true';
        script.addEventListener('load', initializeTable, { once: true });
        document.head.appendChild(script);
      } else if (script.dataset.loaded === 'true') {
        initializeTable();
      } else {
        script.addEventListener('load', initializeTable, { once: true });
      }

      script.addEventListener('load', () => {
        script.dataset.loaded = 'true';
      }, { once: true });
    }

    loadHandsontable();
  })();
</script>

<style>
  .organization-structure {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .organization-structure .page-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .organization-structure .page-header h1 {
    margin: 0;
    font-size: 2rem;
    color: #111827;
  }

  .organization-structure .page-header p {
    margin: 0;
    color: #4b5563;
    line-height: 1.6;
  }

  .organization-structure .table-card {
    background-color: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 1rem;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
  }

  .organization-structure .hot-container {
    width: 100%;
    min-height: 280px;
    overflow: hidden;
  }
</style>
