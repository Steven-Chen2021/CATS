<section class="page-content site-settings" aria-labelledby="siteSettingsTitle">
  <header class="page-header">
    <h1 id="siteSettingsTitle">據點設定</h1>
    <p>根據站點維護各據點的狀態與啟用資訊，可即時新增或調整資料。</p>
  </header>

  <section class="selector-card" aria-labelledby="siteSelectorLabel">
    <div class="selector-field">
      <label id="siteSelectorLabel" for="siteSelector">選擇站點</label>
      <select id="siteSelector" class="site-select" aria-describedby="siteSelectorHelper">
        <option value="" disabled selected>請選擇站點</option>
      </select>
      <p id="siteSelectorHelper" class="helper-text">切換站點以管理其底下的據點。</p>
    </div>
  </section>

  <article class="table-card" aria-label="據點維護表格">
    <div id="siteLocationsTable" class="hot-container" role="application"></div>
    <footer class="table-actions">
      <button type="button" class="primary-button">儲存</button>
    </footer>
  </article>
</section>

<script>
  (function () {
    const siteOptions = [
      { id: 'DIMSHA', name: 'DIMSHA' },
      { id: 'DIMLAX', name: 'DIMLAX' },
      { id: 'DIMTPE', name: 'DIMTPE' }
    ];

    const siteLocationData = {
      DIMSHA: [
        { locationName: '上海營運據點', status: '啟用', statusDate: '2024-03-01' },
        { locationName: '浦東倉儲中心', status: '停用', statusDate: '2023-11-20' }
      ],
      DIMLAX: [
        { locationName: '洛杉磯轉運中心', status: '啟用', statusDate: '2024-01-12' }
      ],
      DIMTPE: [
        { locationName: '台北營運據點', status: '啟用', statusDate: '2024-02-27' }
      ]
    };

    let currentSiteId = siteOptions[0]?.id ?? '';
    let hotInstance = null;

    function getSiteData(siteId) {
      if (!siteLocationData[siteId]) {
        siteLocationData[siteId] = [];
      }

      return siteLocationData[siteId];
    }

    function renderTable(siteId) {
      const container = document.getElementById('siteLocationsTable');
      if (!container || !window.Handsontable) {
        return;
      }

      const data = getSiteData(siteId);

      if (hotInstance) {
        hotInstance.loadData(data);
        return;
      }

      hotInstance = new window.Handsontable(container, {
        data,
        dataSchema: { locationName: '', status: '啟用', statusDate: null },
        colHeaders: ['據點名稱', '狀態', '狀態更新日期'],
        columns: [
          {
            data: 'locationName',
            type: 'text',
            placeholder: '輸入據點名稱',
            validator(value, callback) {
              callback(!value || value.trim().length > 0);
            }
          },
          {
            data: 'status',
            type: 'dropdown',
            source: ['啟用', '停用'],
            allowInvalid: false
          },
          {
            data: 'statusDate',
            type: 'date',
            dateFormat: 'YYYY-MM-DD',
            correctFormat: true,
            allowEmpty: true
          }
        ],
        stretchH: 'all',
        rowHeaders: true,
        licenseKey: 'non-commercial-and-evaluation',
        height: 'auto',
        minSpareRows: 1,
        manualColumnResize: true,
        manualRowResize: true,
        className: 'htMiddle'
      });

      container.__handsontableInstance = hotInstance;
    }

    function initializeTable(siteId) {
      if (!window.Handsontable) {
        console.error('Handsontable 尚未預先載入。');
        return;
      }

      renderTable(siteId);
    }

    function handleSiteChange(event) {
      const selectedSiteId = event.target.value;
      currentSiteId = selectedSiteId;
      if (selectedSiteId) {
        renderTable(selectedSiteId);
      }
    }

    function populateSiteOptions(selectElement) {
      selectElement.innerHTML = '<option value="" disabled>請選擇站點</option>';

      siteOptions.forEach((option, index) => {
        const optionElement = document.createElement('option');
        optionElement.value = option.id;
        optionElement.textContent = option.name;
        if (index === 0) {
          optionElement.selected = true;
        }
        selectElement.appendChild(optionElement);
      });
    }

    function initialize() {
      const siteSelect = document.getElementById('siteSelector');
      if (!siteSelect) {
        return;
      }

      populateSiteOptions(siteSelect);
      currentSiteId = siteSelect.value || currentSiteId;
      siteSelect.addEventListener('change', handleSiteChange);

      if (currentSiteId) {
        initializeTable(currentSiteId);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize, { once: true });
    } else {
      initialize();
    }
  })();
</script>

<style>
  .site-settings {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .site-settings .page-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .site-settings .page-header h1 {
    margin: 0;
    font-size: 2rem;
    color: #111827;
  }

  .site-settings .page-header p {
    margin: 0;
    color: #4b5563;
    line-height: 1.6;
  }

  .site-settings .selector-card {
    background-color: #f9fafb;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .site-settings .selector-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .site-settings label {
    font-weight: 600;
    color: #1f2937;
  }

  .site-settings .site-select {
    width: 100%;
    max-width: 320px;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    color: #111827;
    background-color: #ffffff;
  }

  .site-settings .helper-text {
    margin: 0;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .site-settings .table-card {
    background-color: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 1rem;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .site-settings .hot-container {
    width: 100%;
    min-height: 320px;
    overflow: hidden;
  }

  .site-settings .table-actions {
    display: flex;
    justify-content: flex-end;
  }

  .site-settings .primary-button {
    padding: 0.5rem 1rem;
    font-size: 0.95rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: #2563eb;
    color: #ffffff;
    transition: background-color 0.2s ease;
  }

  .site-settings .primary-button:hover,
  .site-settings .primary-button:focus {
    background: #1d4ed8;
  }
</style>
